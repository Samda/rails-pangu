
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Create a role Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="../ch1/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Home
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../ch1/">
            
                <a href="../ch1/">
            
                    
                    Authentication Strategy
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Create a role
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Create a role</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="create-a-role">Create a role</h1>
<h3 id="generate-role-model">Generate role model</h3>
<p>In the following command you will replace <code>MODEL</code> with the class name used for the application&#x2019;s users (it&#x2019;s frequently <code>User</code> but could also be <code>Admin</code>). This will create a model (if one does not exist) and configure it with the default Devise modules. The generator also configures your <code>config/routes.rb</code> file to point to the Devise controller.</p>
<pre><code>$ rails generate devise MODEL
</code></pre><p>Next, check the MODEL for any additional configuration options you might want to add, such as confirmable or lockable. If you add an option, be sure to inspect the migration file (created by the generator if your ORM supports them) and uncomment the appropriate section. For example, if you add the confirmable option in the model, you&apos;ll need to uncomment the Confirmable section in the migration.</p>
<p>Then run <code>rails db:migrate</code></p>
<p>You should restart your application after changing Devise&apos;s configuration options (this includes stopping spring). Otherwise, you will run into strange errors, for example, users being unable to login and route helpers being undefined.</p>
<h3 id="configuring-controllers">Configuring controllers</h3>
<p>you can customize each controller by following these steps:</p>
<ol>
<li><p>Create your custom controllers using the generator which requires a scope:</p>
<pre><code class="lang-ruby">$ rails generate <span class="hljs-symbol">devise:</span>controllers [scope]
</code></pre>
<p>If you specify <code>users</code> as the scope, controllers will be created in <code>app/controllers/users/</code>. And the sessions controller will look like this:</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Users::SessionsController</span> &lt; Devise::SessionsController</span>
  <span class="hljs-comment"># GET /resource/sign_in</span>
  <span class="hljs-comment"># def new</span>
  <span class="hljs-comment">#   super</span>
  <span class="hljs-comment"># end</span>
  ...
<span class="hljs-keyword">end</span>
</code></pre>
<p>(Use the -c flag to specify a controller, for example: <code>rails generate devise:controllers users -c=sessions</code>)</p>
</li>
<li><p>Tell the router to use this controller:</p>
<pre><code class="lang-ruby">devise_for <span class="hljs-symbol">:users</span>, <span class="hljs-symbol">controllers:</span> { <span class="hljs-symbol">sessions:</span> <span class="hljs-string">&apos;users/sessions&apos;</span> }
</code></pre>
</li>
<li><p>Finally, change or extend the desired controller actions.</p>
<p>You can completely override a controller action:</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Users::SessionsController</span> &lt; Devise::SessionsController</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>
    <span class="hljs-comment"># custom sign-in code</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Or you can simply add new behaviour to it:</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Users::SessionsController</span> &lt; Devise::SessionsController</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>
    <span class="hljs-keyword">super</span> <span class="hljs-keyword">do</span> |resource|
      BackgroundWorker.trigger(resource)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>This is useful for triggering background jobs or logging events during certain actions.</p>
</li>
</ol>
<p>And you can create your custom controllers using the generator which requires a scope:</p>
<pre><code class="lang-ruby">$ rails generate <span class="hljs-symbol">devise:</span>controllers [scope]
</code></pre>
<p>Tell the router to use this controller, you can add devise:controllers you want.</p>
<pre><code class="lang-ruby">devise_for <span class="hljs-symbol">:users</span>, <span class="hljs-symbol">controllers:</span> { <span class="hljs-symbol">sessions:</span> <span class="hljs-string">&apos;users/sessions&apos;</span> }
</code></pre>
<p>You can completely override a controller action:</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Users::SessionsController</span> &lt; Devise::SessionsController</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>
    <span class="hljs-comment"># custom sign-in code</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Or you can simply add new behaviour to it:</p>
<pre><code class="lang-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Users::SessionsController</span> &lt; Devise::SessionsController</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>
    <span class="hljs-keyword">super</span> <span class="hljs-keyword">do</span> |resource|
      BackgroundWorker.trigger(resource)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>You should restart your application after changing Devise&apos;s configuration options (this includes stopping spring). Otherwise, you will run into strange errors, for example, users being unable to login and route helpers being undefined.</p>
<h3 id="configuring-routes">Configuring routes</h3>
<p>Devise also ships with default routes. If you need to customize them, you should probably be able to do it through the devise_for method. It accepts several options like :class_name, :path_prefix and so on, including the possibility to change path names for I18n:</p>
<pre><code class="lang-ruby">devise_for <span class="hljs-symbol">:users</span>, <span class="hljs-symbol">path:</span> <span class="hljs-string">&apos;auth&apos;</span>, <span class="hljs-symbol">path_names:</span> { <span class="hljs-symbol">sign_in:</span> <span class="hljs-string">&apos;login&apos;</span>, <span class="hljs-symbol">sign_out:</span> <span class="hljs-string">&apos;logout&apos;</span>, <span class="hljs-symbol">password:</span> <span class="hljs-string">&apos;secret&apos;</span>, <span class="hljs-symbol">confirmation:</span> <span class="hljs-string">&apos;verification&apos;</span>, <span class="hljs-symbol">unlock:</span> <span class="hljs-string">&apos;unblock&apos;</span>, <span class="hljs-symbol">registration:</span> <span class="hljs-string">&apos;register&apos;</span>, <span class="hljs-symbol">sign_up:</span> <span class="hljs-string">&apos;cmon_let_me_in&apos;</span> }
</code></pre>
<p>If you have the need for more deep customization, for instance to also allow &quot;/sign_in&quot; besides &quot;/users/sign_in&quot;, all you need to do is create your routes normally and wrap them in a <code>devise_scope</code> block in the router:</p>
<pre><code class="lang-ruby">devise_scope <span class="hljs-symbol">:user</span> <span class="hljs-keyword">do</span>
  get <span class="hljs-string">&apos;sign_in&apos;</span>, <span class="hljs-symbol">to:</span> <span class="hljs-string">&apos;devise/sessions#new&apos;</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>This way, you tell Devise to use the scope <code>:user</code> when &quot;/sign_in&quot; is accessed. Notice <code>devise_scope</code> is also aliased as <code>as</code> in your router.</p>
<p>Please note: You will still need to add <code>devise_for</code> in your routes in order to use helper methods such as <code>current_user</code>.</p>
<pre><code class="lang-ruby">devise_for <span class="hljs-symbol">:users</span>, <span class="hljs-symbol">skip:</span> <span class="hljs-symbol">:all</span>
</code></pre>
<h3 id="controller-filters-and-helpers">Controller filters and helpers</h3>
<p>Devise will create some helpers to use inside your controllers and views. To set up a controller with user authentication, just add this before_action (assuming your devise model is &apos;User&apos;):</p>
<pre><code>before_action :authenticate_user!
</code></pre><p>For Rails 5, note that <code>protect_from_forgery</code> is no longer prepended to the <code>before_action</code> chain, so if you have set <code>authenticate_user</code> before <code>protect_from_forgery</code>, your request will result in &quot;Can&apos;t verify CSRF token authenticity.&quot; To resolve this, either change the order in which you call them, or use <code>protect_from_forgery prepend: true</code>.</p>
<p>If your devise model is something other than User, replace &quot;_user&quot; with &quot;_yourmodel&quot;. The same logic applies to the instructions below.</p>
<p>To verify if a user is signed in, use the following helper:</p>
<pre><code>user_signed_in?
</code></pre><p>For the current signed-in user, this helper is available:</p>
<pre><code>current_user
</code></pre><h3 id="controller-tests">Controller tests</h3>
<p>You can use the <code>sign_in</code> and <code>sign_out</code> methods on your controller tests:</p>
<pre><code>sign_in @user
sign_in @user, scope: :admin
</code></pre><p>If you are testing Devise internal controllers or a controller that inherits from Devise&apos;s, you need to tell Devise which mapping should be used before a request. This is necessary because Devise gets this information from the router, but since controller tests do not pass through the router, it needs to be stated explicitly. For example, if you are testing the user scope, simply use:</p>
<pre><code class="lang-ruby">it <span class="hljs-string">&apos;GET new&apos;</span> <span class="hljs-keyword">do</span>
  <span class="hljs-comment"># Mimic the router behavior of setting the Devise scope through the env.</span>
  @request.env[<span class="hljs-string">&apos;devise.mapping&apos;</span>] = Devise.mappings[<span class="hljs-symbol">:user</span>]

  <span class="hljs-comment"># Use the sign_in helper to sign in a fixture `User` record.</span>
  sign_in users(<span class="hljs-symbol">:alice</span>)

  get <span class="hljs-symbol">:new</span>

  <span class="hljs-comment"># assert something</span>
<span class="hljs-keyword">end</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../ch1/" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Authentication Strategy">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Create a role","level":"1.3","depth":1,"previous":{"title":"Authentication Strategy","level":"1.2","depth":1,"path":"ch1/README.md","ref":"ch1/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"ch2/README.md","mtime":"2020-08-03T03:07:10.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-08-03T02:55:21.695Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

